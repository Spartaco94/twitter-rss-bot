name: Tweet all blogs from RSS

on:
  schedule:
    - cron: "*/10 * * * *"     # controlla ogni 10 minuti
  workflow_dispatch: {}         # avvio manuale per test

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install tweepy==4.14.0 feedparser==6.0.11

      - name: Run multi-feed bot
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}

          # --- elenco blog + hashtag ---
          FEEDS_JSON: |
            [
              {
                "name": "Crypto Radar Daily",
                "feed": "https://cryptoradarboard.blogspot.com/feeds/posts/default",
                "tags": "üîó #Crypto #Bitcoin #DeFi #Blockchain"
              },
              {
                "name": "Tech Trends Daily",
                "feed": "https://techtrendsdailyboard.blogspot.com/feeds/posts/default",
                "tags": "ü§ñ #Tech #AI #Innovation"
              },
              {
                "name": "NomadVibes",
                "feed": "https://nomadvibesboard.blogspot.com/feeds/posts/default",
                "tags": "üåç #Travel #DigitalNomad"
              },
              {
                "name": "Healthy Eating Hub",
                "feed": "https://healthyeatsboard.blogspot.com/feeds/posts/default",
                "tags": "ü•ó #Healthy #Nutrition"
              },
              {
                "name": "Fitness Home Journal",
                "feed": "https://fitnesshomejournal.blogspot.com/feeds/posts/default",
                "tags": "üèãÔ∏è #Fitness #Workout"
              },
              {
                "name": "GreenPlanet News",
                "feed": "https://greenplanetpins.blogspot.com/feeds/posts/default",
                "tags": "üåø #Climate #Sustainability"
              },
              {
                "name": "PetCare Updates",
                "feed": "https://petcareinspo.blogspot.com/feeds/posts/default",
                "tags": "üêæ #PetCare #Dogs #Cats"
              }
            ]
        run: |
          python - <<'PY'
          import os, json, re, time, pathlib
          import feedparser, tweepy

          # --- auth X ---
          auth = tweepy.OAuth1UserHandler(
              os.getenv("X_API_KEY"),
              os.getenv("X_API_SECRET"),
              os.getenv("X_ACCESS_TOKEN"),
              os.getenv("X_ACCESS_SECRET")
          )
          api = tweepy.API(auth)

          # --- stato per evitare duplicati ---
          STATE_PATH = pathlib.Path("state.json")
          state = json.loads(STATE_PATH.read_text()) if STATE_PATH.exists() else {}

          def clean(s): 
              return re.sub(r"\s+"," ", s).strip()

          def build_tweet(title, link, tags, max_len=270):
              # lascia qualche carattere di buffer
              base = f"{title} {tags} {link}"
              if len(base) <= max_len:
                  return base
              room = max_len - len(tags) - len(link) - 2
              short = (title[:room-1] + "‚Ä¶") if room > 10 else title[:room]
              return f"{short} {tags} {link}"

          feeds = json.loads(os.environ["FEEDS_JSON"])
          changed = False
          posted = 0

          for f in feeds:
              name, url, tags = f["name"], f["feed"], f["tags"]
              print(f"‚Üí Checking {name}: {url}")
              d = feedparser.parse(url)
              if not d.entries:
                  print("  (no entries)")
                  continue

              latest = d.entries[0]
              uid = getattr(latest, "id", latest.link)

              if state.get(name) == uid:
                  print("  (no new post)")
                  continue

              title = clean(latest.title)
              link = latest.link
              tweet = build_tweet(title, link, tags)

              try:
                  api.update_status(status=tweet)
                  print(f"  ‚úÖ Tweeted: {tweet}")
                  state[name] = uid
                  changed = True
                  posted += 1
                  time.sleep(2)  # piccolo delay anti rate-limit
              except Exception as e:
                  print(f"  ‚ùå Error tweeting {name}: {e}")

          if changed:
              STATE_PATH.write_text(json.dumps(state, indent=2))
              print(f"Saved state.json. Posted {posted} tweets.")
          else:
              print("Nothing new to tweet.")
          PY

      - name: Commit state (if changed)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update state.json"
          file_pattern: state.json
